# Sealights Get Refs Tekton Task

## Overview

The `sealights-get-refs` Tekton Task is designed to retrieve metadata related to Sealights instrumentation in a CI pipeline. This Task extracts key information, such as the Sealights Build Session ID, the source artifact type, the instrumented container image, and the build name. It does so by processing attestation data associated with a container image using `cosign`. The `sealights-get-refs task is available to work only in Konflux CI integration tests.

## Task Description

The Task performs the following steps:
1. Retrieves the container image associated with the specified component from the provided `SNAPSHOT` parameter.
2. Downloads the attestation metadata using `cosign`.
3. Parses the attestation metadata to extract Sealights-related information.
4. Writes the extracted information to Tekton Task results.

## Parameters

| Name       | Type   | Description                                  |
|------------|--------|----------------------------------------------|
| `SNAPSHOT` | string | The JSON string representing the Snapshot under test. |

## Results

| Name                         | Description                                                                     |
|-------------------------------|---------------------------------------------------------------------------------|
| `sealights-source-artifact`  | The source code OCI artifact that was instrumented with sealights.             |
| `sealights-bsid`             | The Build Session ID (BSID) generated during the build for sealights.          |
| `sealights-container-image`  | The container image used in the Sealights instrumentation process.             |
| `sealights-build-name`       | The build name generated by sealights instrumentation.                         |
| `container-image`            | The container image built from the specified Git revision without Sealights instrumentation. |

## Usage Example

Here's an example of how to use the `sealights-get-refs` Task in a Tekton Pipeline:

```yaml
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: example-sealights-pipeline
spec:
  params:
    - name: snapshot
      description: "The Snapshot JSON string"
  tasks:
    - name: get-sealights-refs
      taskRef:
        name: sealights-get-refs
      params:
        - name: SNAPSHOT
          value: "$(params.snapshot)"
```

## Dependencies

To fully integrate instrumentation in your Konflux-CI build pipelines, you'll need to update the build YAML files located in the `.tekton` folder. This involves adding instrumentation tasks for specific languages and, for Go projects, triggering a second build to generate trusted artifacts a second container.

## Adding Instrumentation Task

### General Template for Instrumentation

Insert the following snippet **after** the `clone-repository` task to add the instrumentation step:

```yaml
# This example is for a push event
- name: sealights-instrumentation
  runAfter:
    - clone-repository
  taskRef:
    resolver: git
    params:
      - name: url
        value: https://github.com/konflux-ci/tekton-integration-catalog.git
      - name: revision
        value: main
      - name: pathInRepo
        value: tasks/sealights/sealights-go-instrumentation/0.1/sealights-go-instrumentation.yaml
  params:
    - name: source-artifact
      value: $(tasks.clone-repository.results.SOURCE_ARTIFACT)
    - name: go-version
      value: "1.22"
    - name: sealights-secret
      value: "sealights-credentials"
    - name: component
      value: '{{ repo_name }}'
    - name: branch
      value: '{{ source_branch }}'
    - name: revision
      value: '{{ revision }}'
    - name: oci-storage
      value: $(params.output-image).sealights.git
```

## Adding a Second Build Task for Go Projects

For Go projects, you need a second build task after the `prefetch-dependencies` task to generate a trusted artifact containing the instrumented code.

### Example: Second Build for Go (not applied to NodeJs or Python)

Add the following snippet after `prefetch-dependencies`:

```yaml
- name: build-sealights-container
  params:
    - name: IMAGE
      value: $(params.output-image).sealights
    - name: DOCKERFILE
      value: $(params.dockerfile)
    - name: CONTEXT
      value: $(params.path-context)
    - name: HERMETIC
      value: $(params.hermetic)
    - name: PREFETCH_INPUT
      value: $(params.prefetch-input)
    - name: IMAGE_EXPIRES_AFTER
      value: $(params.image-expires-after)
    - name: COMMIT_SHA
      value: $(tasks.clone-repository.results.commit)
    - name: BUILD_ARGS
      value:
        - $(params.build-args[*])
    - name: BUILD_ARGS_FILE
      value: $(params.build-args-file)
    - name: SOURCE_ARTIFACT
      value: $(tasks.sealights-instrumentation.results.source-artifact) <---- This is super important to update
    - name: CACHI2_ARTIFACT
      value: $(tasks.prefetch-dependencies.results.CACHI2_ARTIFACT)
  runAfter:
    - prefetch-dependencies
  taskRef:
    params:
      - name: name
        value: buildah-oci-ta
      - name: bundle
        value: quay.io/konflux-ci/tekton-catalog/task-buildah-oci-ta:0.2@sha256:937f465189482f3279b9491161fff7720d4c443f27e6d9febbf2344268383011
      - name: kind
        value: task
    resolver: bundles
  when:
    - input: $(tasks.init.results.build)
      operator: in
      values:
        - "true"
```
